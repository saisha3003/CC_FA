<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lost & Found Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1149.0.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* --- Custom Animations & Styling --- */
        body { font-family: 'Lato', sans-serif; }
        .font-serif-display { font-family: 'DM Serif Display', serif; }

        [data-page] { display: none; }
        [data-page="login"] { display: grid; }
        
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .tab-active {
            background-color: #5B4F4A;
            color: white;
            font-weight: 700;
        }

        .page-fade-in {
            animation: fadeIn 0.5s ease-in-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card-slide-up {
            animation: slideUp 0.5s ease-out forwards;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-enter {
            animation: modalFadeIn 0.3s ease-out forwards;
        }
        .modal-leave {
            animation: modalFadeOut 0.3s ease-in forwards;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes modalFadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
    </style>
</head>
<body class="bg-[#E9E4DB] antialiased text-[#332D2D]">

    <div id="app">

        <!-- Login Page -->
        <main id="loginPage" data-page="login" class="min-h-screen grid md:grid-cols-2">
            <div class="hidden md:flex flex-col justify-center bg-[#5B4F4A] text-white p-12 relative overflow-hidden">
                <div class="z-10 relative">
                    <h1 class="text-5xl font-bold mb-4 font-serif-display">Reunite</h1>
                    <p class="text-xl text-gray-200 mb-8">Helping you find what's been misplaced.</p>
                    <div class="space-y-6 text-gray-100">
                        <div>
                            <h3 class="font-semibold text-lg mb-2">Find or Post:</h3>
                            <ul class="list-disc list-inside space-y-2">
                                <li>Easily post a lost item.</li>
                                <li>Search for items you've found.</li>
                                <li>Connect with the community.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex flex-col justify-center items-center bg-[#F5F3ED] p-8 md:p-12">
                <div class="w-full max-w-md">
                    <h2 class="text-3xl font-bold text-[#332D2D] mb-6 text-center font-serif-display">Welcome Back!</h2>
                    <form id="loginForm" class="space-y-6">
                        <div>
                            <label for="loginEmail" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="loginEmail" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-[#8B6D55] focus:border-[#8B6D55] sm:text-sm">
                        </div>
                        <div>
                            <label for="loginPassword" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="loginPassword" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-[#8B6D55] focus:border-[#8B6D55] sm:text-sm">
                        </div>
                        <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-[#8B6D55] hover:bg-[#6A4B2D] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#8B6D55] transition duration-300 transform hover:scale-105">
                            Log In
                        </button>
                    </form>
                    <p class="mt-6 text-center text-sm text-gray-600">
                        Donâ€™t have an account?
                        <a href="#" id="navigateToSignup" class="font-medium text-[#8B6D55] hover:text-[#6A4B2D] transition-colors duration-200">Sign Up</a>
                    </p>
                </div>
            </div>
        </main>
        
        <!-- Signup Page -->
        <main id="signupPage" data-page="signup" class="min-h-screen grid md:grid-cols-2">
            <div class="hidden md:flex flex-col justify-center bg-[#5B4F4A] text-white p-12 relative overflow-hidden">
                <div class="z-10 relative">
                    <h1 class="text-5xl font-bold mb-4 font-serif-display">Reunite</h1>
                    <p class="text-xl text-gray-200 mb-8">Join the community and help reunite people with their belongings.</p>
                    <div class="space-y-6 text-gray-100">
                        <div>
                            <h3 class="font-semibold text-lg mb-2">Getting Started is Easy:</h3>
                            <ul class="list-disc list-inside space-y-2">
                                <li>Create a profile in under a minute.</li>
                                <li>Post items you have found.</li>
                                <li>Search for your lost possessions.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex flex-col justify-center items-center bg-[#F5F3ED] p-8 md:p-12">
                <div class="w-full max-w-md">
                    <h2 class="text-3xl font-bold text-[#332D2D] mb-6 text-center font-serif-display">Create Your Account</h2>
                    <form id="signupForm" class="space-y-5">
                        <div>
                            <label for="signupName" class="block text-sm font-medium text-gray-700">Your Name</label>
                            <input type="text" id="signupName" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-[#8B6D55] focus:border-[#8B6D55] sm:text-sm">
                        </div>
                        <div>
                            <label for="signupEmail" class="block text-sm font-medium text-gray-700">Email Address</label>
                            <input type="email" id="signupEmail" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-[#8B6D55] focus:border-[#8B6D55] sm:text-sm">
                        </div>
                        <div>
                            <label for="signupPassword" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="signupPassword" required minlength="6" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-[#8B6D55] focus:border-[#8B6D55] sm:text-sm">
                        </div>
                        <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-[#8B6D55] hover:bg-[#6A4B2D] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#8B6D55] transition duration-300 transform hover:scale-105">
                            Sign Up
                        </button>
                    </form>
                    <p class="mt-6 text-center text-sm text-gray-600">
                        Already have an account?
                        <a href="#" id="navigateToLogin" class="font-medium text-[#8B6D55] hover:text-[#6A4B2D] transition-colors duration-200">Log In</a>
                    </p>
                </div>
            </div>
        </main>
        
        <!-- Main Items Page -->
        <main id="itemsPage" data-page="items" class="bg-[#E9E4DB] min-h-screen">
            <header class="bg-[#F5F3ED] shadow-md sticky top-0 z-10">
                <nav class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-col sm:flex-row justify-between items-center">
                    <div class="mb-2 sm:mb-0">
                        <h1 class="text-3xl font-bold font-serif-display text-[#5B4F4A]">Reunite</h1>
                        <p class="text-sm text-gray-500">Lost & Found</p>
                    </div>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                        <div class="flex items-center space-x-2">
                           <div>
                                <h2 id="welcomeUserName" class="text-xl font-semibold text-[#332D2D] text-right"></h2>
                                <p id="welcomeUserEmail" class="text-sm text-gray-500 text-right"></p>
                            </div>
                            <button id="logoutButton" class="inline-flex items-center justify-center px-4 py-2 border-2 border-[#8B6D55] text-sm font-medium rounded-lg text-[#8B6D55] bg-[#F5F3ED] hover:bg-[#EAE8E4] transition duration-300">
                                <i class="fa-solid fa-right-from-bracket"></i>
                            </button>
                        </div>
                    </div>
                </nav>
            </header>
            
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="mb-6 bg-[#F5F3ED] p-2 rounded-xl shadow-sm flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                    <button id="openItemModalBtn" class="sm:flex-1 inline-flex items-center justify-center px-4 py-3 border border-transparent text-sm font-medium rounded-lg text-white bg-[#8B6D55] hover:bg-[#6A4B2D] transition duration-300">
                        <i class="fa-solid fa-plus mr-2"></i> Post New Item
                    </button>
                    <button data-tab="lost" class="item-tab sm:flex-1 text-center px-4 py-3 rounded-xl transition-colors duration-200 hover:bg-[#EAE8E4]"><i class="fa-solid fa-list-ul mr-2"></i>Lost Items</button>
                    <button data-tab="found" class="item-tab sm:flex-1 text-center px-4 py-3 rounded-xl transition-colors duration-200 hover:bg-[#EAE8E4]"><i class="fa-solid fa-search mr-2"></i>Found Items</button>
                    <button data-tab="my" class="item-tab sm:flex-1 text-center px-4 py-3 rounded-xl transition-colors duration-200 hover:bg-[#EAE8E4]"><i class="fa-solid fa-user mr-2"></i>My Items</button>
                </div>
                
                <h2 id="itemListHeader" class="text-2xl font-bold text-[#5B4F4A] mb-6 font-serif-display">Lost Items</h2>
                <div id="itemList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="col-span-full text-center text-gray-500">Loading items from S3...</p>
                </div>
            </div>
        </main>

        <!-- Item Modal (for adding/editing) -->
        <div id="itemModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
            <div class="bg-[#F5F3ED] modal-content rounded-xl shadow-2xl w-full max-w-2xl max-h-full overflow-y-auto modal-enter">
                <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                    <h2 id="modalTitle" class="text-xl font-semibold text-[#332D2D]">Post a New Item</h2>
                    <button id="closeItemModalBtn" class="text-gray-400 hover:text-gray-600 text-2xl transition-transform transform hover:rotate-90">&times;</button>
                </div>
                <form id="itemForm" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <input type="hidden" id="itemId">
                    <div class="md:col-span-2">
                        <label for="itemType" class="block text-sm font-medium text-gray-700">Type</label>
                        <select id="itemType" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-[#8B6D55] focus:border-[#8B6D55]">
                            <option value="lost">Lost</option>
                            <option value="found">Found</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="itemName" class="block text-sm font-medium text-gray-700">Item Name</label>
                        <input type="text" id="itemName" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-[#8B6D55] focus:border-[#8B6D55]">
                    </div>
                    <div class="md:col-span-2">
                        <label for="itemDescription" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="itemDescription" rows="3" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-[#8B6D55] focus:border-[#8B6D55]"></textarea>
                    </div>
                    <div>
                        <label for="itemDate" class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" id="itemDate" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-[#8B6D55] focus:border-[#8B6D55]">
                    </div>
                    <div>
                        <label for="itemImages" class="block text-sm font-medium text-gray-700">Item Images</label>
                        <input type="file" id="itemImages" multiple accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[#EAE8E4] file:text-[#8B6D55] hover:file:bg-[#D4D2CD] transition duration-300">
                        <p class="text-xs text-gray-500 mt-1">For updates, selecting new images will replace old ones.</p>
                    </div>
                    <div class="md:col-span-2 text-right">
                        <button type="submit" class="inline-flex items-center justify-center px-6 py-3 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-[#8B6D55] hover:bg-[#6A4B2D] transition duration-300 transform hover:scale-105">
                            <span id="saveItemBtnText">Save Item</span>
                            <div id="saveItemSpinner" class="loading-spinner hidden"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
    class ItemManager {
        constructor() {
            // --- AWS S3 Configuration ---
            const AWS_CONFIG = {
                region: 'eu-north-1',
                accessKeyId: 'AKIA36UVB2U4VSIHU36S',
                secretAccessKey: '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',
                bucketName: 'adityaccfa'
            };

            this.AWS_CONFIG = AWS_CONFIG;
            this.s3 = this.initializeS3();

            // --- DOM Element References ---
            this.pages = { login: document.getElementById('loginPage'), signup: document.getElementById('signupPage'), items: document.getElementById('itemsPage') };
            this.loginForm = document.getElementById('loginForm');
            this.signupForm = document.getElementById('signupForm');
            this.navigateToSignup = document.getElementById('navigateToSignup');
            this.navigateToLogin = document.getElementById('navigateToLogin');
            this.logoutButton = document.getElementById('logoutButton');
            this.itemList = document.getElementById('itemList');
            this.welcomeUserName = document.getElementById('welcomeUserName');
            this.welcomeUserEmail = document.getElementById('welcomeUserEmail');
            this.itemModal = document.getElementById('itemModal');
            this.openItemModalBtn = document.getElementById('openItemModalBtn');
            this.closeItemModalBtn = document.getElementById('closeItemModalBtn');
            this.itemForm = document.getElementById('itemForm');
            this.modalTitle = document.getElementById('modalTitle');
            this.itemTabs = document.querySelectorAll('.item-tab');
            this.itemListHeader = document.getElementById('itemListHeader');

            // --- State Management ---
            this.currentUser = null;
            this.allFetchedItems = [];
            this.activeTab = 'lost';

            this.bindEventListeners();
            this.showPage('login');
        }

        initializeS3() {
            if (this.AWS_CONFIG.accessKeyId !== 'YOUR_IAM_USER_ACCESS_KEY_ID') {
                AWS.config.update({
                    region: this.AWS_CONFIG.region,
                    accessKeyId: this.AWS_CONFIG.accessKeyId,
                    secretAccessKey: this.AWS_CONFIG.secretAccessKey
                });
                return new AWS.S3({ apiVersion: '2006-03-01' });
            }
            console.warn("AWS S3 credentials are not configured.");
            return null;
        }

        bindEventListeners() {
            this.navigateToSignup.addEventListener('click', (e) => { e.preventDefault(); this.showPage('signup'); });
            this.navigateToLogin.addEventListener('click', (e) => { e.preventDefault(); this.showPage('login'); });
            this.loginForm.addEventListener('submit', (e) => this.handleLogin(e));
            this.signupForm.addEventListener('submit', (e) => this.handleSignup(e));
            this.logoutButton.addEventListener('click', () => this.handleLogout());
            this.openItemModalBtn.addEventListener('click', () => this.openItemModal());
            this.closeItemModalBtn.addEventListener('click', () => this.closeItemModal());
            this.itemModal.addEventListener('click', (e) => { if(e.target === this.itemModal) this.closeItemModal(); });
            this.itemForm.addEventListener('submit', (e) => this.handleSaveItem(e));
            this.itemTabs.forEach(tab => tab.addEventListener('click', (e) => this.handleTabClick(e)));
        }

        showPage(pageName) {
            const allPages = Object.values(this.pages);
            allPages.forEach(page => page.classList.remove('page-fade-in'));
            allPages.forEach(page => page.style.display = 'none');
            if (this.pages[pageName]) {
                const isGridLayout = this.pages[pageName].classList.contains('grid');
                this.pages[pageName].style.display = isGridLayout ? 'grid' : 'block';
                this.pages[pageName].classList.add('page-fade-in');
            }
        }
        
        // --- Modal & Form Logic ---
        openItemModal(itemId = null) {
            this.itemForm.reset();
            document.getElementById('itemId').value = '';
            if (itemId) {
                const item = this.allFetchedItems.find(e => e.id === itemId);
                if (item) {
                    this.modalTitle.textContent = "Edit Item";
                    document.getElementById('itemId').value = item.id;
                    document.getElementById('itemType').value = item.itemType;
                    document.getElementById('itemName').value = item.itemName;
                    document.getElementById('itemDescription').value = item.description;
                    document.getElementById('itemDate').value = item.date;
                }
            } else {
                this.modalTitle.textContent = "Post a New Item";
            }
            this.itemModal.classList.remove('hidden');
            this.itemModal.classList.add('flex');
            this.itemModal.querySelector('.modal-content').classList.add('modal-enter');
            this.itemModal.querySelector('.modal-content').classList.remove('modal-leave');
        }
        
        closeItemModal() {
            const modalContent = this.itemModal.querySelector('.modal-content');
            modalContent.classList.add('modal-leave');
            modalContent.classList.remove('modal-enter');
            modalContent.addEventListener('animationend', () => {
                this.itemModal.classList.add('hidden');
                this.itemModal.classList.remove('flex');
            }, { once: true });
        }

        // --- Authentication ---
        handleSignup(e) {
            e.preventDefault();
            const userName = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim().toLowerCase();
            const password = document.getElementById('signupPassword').value;
            if (!userName || !email || !password) return this.showMessage('Please fill all fields.');
            const users = JSON.parse(localStorage.getItem('lostAndFoundUsers')) || [];
            if (users.find(user => user.email === email)) return this.showMessage('An account with this email already exists.');
            users.push({ userName, email, password });
            localStorage.setItem('lostAndFoundUsers', JSON.stringify(users));
            this.showMessage('Signup successful! Please log in.');
            this.showPage('login');
        }

        handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;
            const users = JSON.parse(localStorage.getItem('lostAndFoundUsers')) || [];
            const user = users.find(u => u.email === email && u.password === password);
            if (user) {
                this.currentUser = user;
                this.initializeAppForUser();
            } else {
                this.showMessage('Invalid email or password.');
            }
        }
        
        handleLogout() {
            this.currentUser = null;
            this.allFetchedItems = [];
            this.itemList.innerHTML = '';
            this.showPage('login');
        }

        initializeAppForUser() {
            this.welcomeUserName.textContent = `Welcome, ${this.currentUser.userName}!`;
            this.welcomeUserEmail.textContent = this.currentUser.email;
            this.showPage('items');
            this.setActiveTab('lost');
            this.fetchAllItems();
        }

        // --- Tab Logic ---
        handleTabClick(e) {
            this.setActiveTab(e.target.dataset.tab);
            this.renderItems();
        }
        
        setActiveTab(tabName) {
            this.activeTab = tabName;
            const headers = { lost: "Lost Items", found: "Found Items", my: "My Items" };
            this.itemListHeader.textContent = headers[tabName];
            this.itemTabs.forEach(tab => tab.classList.toggle('tab-active', tab.dataset.tab === tabName));
        }

        // --- Item CRUD Operations ---
        async handleSaveItem(e) {
            e.preventDefault();
            if (!this.s3) return this.showMessage("S3 is not configured.");
            
            const itemId = document.getElementById('itemId').value;
            const itemType = document.getElementById('itemType').value;
            const itemName = document.getElementById('itemName').value.trim();
            const itemDescription = document.getElementById('itemDescription').value.trim();
            const itemDate = document.getElementById('itemDate').value;
            const newImages = document.getElementById('itemImages').files;
            
            if (!itemName || !itemDescription || !itemDate) return this.showMessage("Please fill all item details.");
            
            this.toggleSpinner(true);
            
            try {
                let existingItem = null;
                let imageKeys = [];
                
                if (itemId) {
                    existingItem = this.allFetchedItems.find(e => e.id === itemId);
                    imageKeys = existingItem.imageKeys || [];
                    
                    if (newImages.length > 0 && imageKeys.length > 0) {
                        await this.deleteImagesFromS3(imageKeys);
                        imageKeys = [];
                    }
                }
                
                if (newImages.length > 0) {
                    const uploadedKeys = await this.uploadImagesToS3(newImages, itemName);
                    imageKeys.push(...uploadedKeys);
                }

                const itemData = {
                    id: itemId || `item_${Date.now()}`,
                    itemType,
                    itemName,
                    description: itemDescription,
                    date: itemDate,
                    imageKeys,
                    postedBy: this.currentUser.email,
                    posterName: this.currentUser.userName,
                };

                if (itemId) {
                    const index = this.allFetchedItems.findIndex(e => e.id === itemId);
                    this.allFetchedItems[index] = itemData;
                } else {
                    this.allFetchedItems.push(itemData);
                }

                await this.updateItemsOnS3();
                this.showMessage(`Item ${itemId ? 'updated' : 'posted'} successfully!`);
                this.closeItemModal();
                this.renderItems();

            } catch (error) {
                console.error("Error saving item:", error);
                this.showMessage("Failed to save item.");
            } finally {
                this.toggleSpinner(false);
            }
        }

        async handleDeleteClick(itemId) {
            // Note: window.confirm is not supported. This action will proceed without confirmation.
            try {
                const itemToDelete = this.allFetchedItems.find(e => e.id === itemId);
                
                if (itemToDelete && itemToDelete.imageKeys && itemToDelete.imageKeys.length > 0) {
                    await this.deleteImagesFromS3(itemToDelete.imageKeys);
                }

                this.allFetchedItems = this.allFetchedItems.filter(e => e.id !== itemId);

                await this.updateItemsOnS3();
                
                this.showMessage("Item deleted successfully.");
                this.renderItems();

            } catch (error) {
                console.error("Error deleting item:", error);
                this.showMessage("Failed to delete item.");
            }
        }

        async fetchAllItems() {
            if (!this.s3) {
                this.itemList.innerHTML = `<p class="col-span-full text-center text-red-500">S3 is not configured.</p>`;
                return;
            }
            this.itemList.innerHTML = `<p class="col-span-full text-center text-gray-500">Fetching items from S3...</p>`;
            try {
                const data = await this.s3.getObject({ Bucket: this.AWS_CONFIG.bucketName, Key: 'lost_found.json' }).promise();
                this.allFetchedItems = JSON.parse(data.Body.toString('utf-8'));
                this.renderItems();
            } catch (err) {
                if (err.code === 'NoSuchKey') {
                    this.allFetchedItems = [];
                    this.renderItems();
                } else {
                    console.error("Error fetching items:", err);
                    this.itemList.innerHTML = `<p class="col-span-full text-center text-red-500">Failed to load items.</p>`;
                }
            }
        }

        renderItems() {
            let filteredItems = [];
            
            if (this.activeTab === 'lost') {
                filteredItems = this.allFetchedItems.filter(item => item.itemType === 'lost');
            } else if (this.activeTab === 'found') {
                filteredItems = this.allFetchedItems.filter(item => item.itemType === 'found');
            } else if (this.activeTab === 'my') {
                filteredItems = this.allFetchedItems.filter(item => item.postedBy === this.currentUser.email);
            }
            
            if (filteredItems.length === 0) {
                this.itemList.innerHTML = `<p class="col-span-full text-center text-gray-600">No items found in this category.</p>`;
                return;
            }
            
            filteredItems.sort((a, b) => new Date(b.date) - new Date(a.date));
            this.itemList.innerHTML = filteredItems.map((item, index) => this.createItemCard(item, index)).join('');
        }

        createItemCard(item, index) {
            const imageUrls = (item.imageKeys || []).map(key => this.s3.getSignedUrl('getObject', { Bucket: this.AWS_CONFIG.bucketName, Key: key, Expires: 3600 }));
            const imagesHtml = imageUrls.length > 0 ?
                `<div class="mt-4 grid grid-cols-2 gap-2">
                    ${imageUrls.slice(0, 4).map(url => `<img src="${url}" alt="Item image" class="w-full h-24 object-cover rounded-md">`).join('')}
                </div>` : '';
            
            const actionButtons = this.activeTab === 'my' ? `
                <div class="mt-4 pt-4 border-t border-gray-100 flex space-x-2">
                    <button onclick="app.openItemModal('${item.id}')" class="flex-1 text-sm bg-[#8B6D55] text-white py-2 px-4 rounded-lg hover:bg-[#6A4B2D] transition-colors duration-300"><i class="fa-solid fa-pen-to-square"></i> Edit</button>
                    <button onclick="app.handleDeleteClick('${item.id}')" class="flex-1 text-sm bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors duration-300"><i class="fa-solid fa-trash-can"></i> Delete</button>
                </div>` : '';

            const itemTypeColor = item.itemType === 'lost' ? 'text-[#C95B5B]' : 'text-[#5B9C5B]';

            return `
                <div class="bg-[#F5F3ED] p-6 rounded-xl shadow-lg flex flex-col transition duration-300 hover:shadow-2xl transform hover:-translate-y-1 card-slide-up" style="animation-delay: ${index * 0.05}s;">
                    <div class="flex-grow">
                        <div class="flex justify-between items-start">
                            <h3 class="text-xl font-bold text-[#332D2D] font-serif-display">${item.itemName}</h3>
                            <p class="text-sm text-gray-600 font-semibold flex-shrink-0 ml-2">${new Date(item.date).toLocaleDateString()}</p>
                        </div>
                        <p class="text-sm font-medium ${itemTypeColor} mt-1">${item.itemType === 'lost' ? 'Lost' : 'Found'} by ${item.posterName}</p>
                        <p class="text-gray-700 mt-2 text-sm">${item.description}</p>
                        ${imagesHtml}
                    </div>
                    ${actionButtons}
                </div>`;
        }

        // --- S3 Helper Functions ---
        async uploadImagesToS3(files, itemName) {
            const safeUserName = this.currentUser.userName.replace(/\s+/g, '-').toLowerCase();
            const safeItemName = itemName.replace(/\s+/g, '-').toLowerCase();
            const uploadPromises = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const key = `items/${safeUserName}_${safeItemName}_${Date.now()}_${i}.${file.name.split('.').pop()}`;
                uploadPromises.push(this.s3.upload({ Bucket: this.AWS_CONFIG.bucketName, Key: key, Body: file, ContentType: file.type }).promise());
            }

            const results = await Promise.all(uploadPromises);
            return results.map(result => result.Key);
        }

        async deleteImagesFromS3(keys) {
            if (!keys || keys.length === 0) return;
            const objects = keys.map(key => ({ Key: key }));
            await this.s3.deleteObjects({ Bucket: this.AWS_CONFIG.bucketName, Delete: { Objects: objects } }).promise();
        }
        
        async updateItemsOnS3() {
            await this.s3.putObject({
                Bucket: this.AWS_CONFIG.bucketName,
                Key: 'lost_found.json',
                Body: JSON.stringify(this.allFetchedItems, null, 2),
                ContentType: 'application/json'
            }).promise();
        }
        
        // --- UI Helpers ---
        toggleSpinner(isLoading) {
            const btn = document.getElementById('itemForm').querySelector('button[type="submit"]');
            const btnText = document.getElementById('saveItemBtnText');
            const spinner = document.getElementById('saveItemSpinner');
            btn.disabled = isLoading;
            btnText.classList.toggle('hidden', isLoading);
            spinner.classList.toggle('hidden', !isLoading);
        }

        showMessage(message) {
            // A simple modal/message box implementation is needed here
            // Replacing alert() and confirm() as they are not supported in the environment
            console.log(message);
        }
    }

    window.app = new ItemManager();
    </script>
</body>
</html>
